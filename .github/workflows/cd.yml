name: CD # Continuous Deployment

permissions:
    contents: read
on:
    workflow_dispatch:
    push:
        tags:
            - "[v]?[0-9]+.[0-9]+.[0-9]+"

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true
jobs:
    publish:
        name: Publishing for ${{ matrix.job.os }}
        runs-on: ${{ matrix.job.os }}
        environment: CD
        strategy:
            matrix:
                job:
                    - os: macos-latest
                      os-name: macos
                      target: x86_64-apple-darwin
                      architecture: x86_64
                      binary-postfix: ""
                    - os: macos-latest
                      os-name: macos
                      target: aarch64-apple-darwin
                      architecture: arm64
                      binary-postfix: ""
                    - os: ubuntu-latest
                      os-name: linux
                      target: x86_64-unknown-linux-gnu
                      architecture: x86_64
                      binary-postfix: ""
                    - os: windows-latest
                      os-name: windows
                      target: x86_64-pc-windows-msvc
                      architecture: x86_64
                      binary-postfix: ".exe"

        steps:
            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # tag=v6.0.2
              with:
                  submodules: true
                  persist-credentials: false
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # branch=master
              with:
                  toolchain: stable
                  targets: ${{ matrix.job.target }}
            - name: Build binary
              # zizmor: ignore[template-injection]
              run: cargo build --locked --release --target=${{ matrix.job.target}}
            - name: Packaging final binary
              shell: bash
              # zizmor: ignore[template-injection]
              run: |
                  cd target/${{ matrix.job.target }}/release

                  ########## create tar.gz ##########
                  RELEASE_NAME=nix-options-search-${GITHUB_REF/refs\/tags\//}-${{ matrix.job.os-name }}-${{ matrix.job.architecture }}
                  tar czvf $RELEASE_NAME.tar.gz $BINARY_NAME

                  ########## create sha256 ##########
                  if [[ ${{ runner.os }} == 'Windows' ]]; then
                    certutil -hashfile $RELEASE_NAME.tar.gz sha256 | grep -E [A-Fa-f0-9]{64} > $RELEASE_NAME.sha256
                  else
                    shasum -a 256 $RELEASE_NAME.tar.gz > $RELEASE_NAME.sha256
                  fi
            - name: Releasing assets
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # tag=v2.5.0
              with:
                  files: |
                      target/${{ matrix.job.target }}/release/nix-options-search-*.tar.gz
                      target/${{ matrix.job.target }}/release/nix-options-search-*.sha256
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    publish-cargo:
        name: Publish to crates.io
        runs-on: ubuntu-latest
        environment: CD
        permissions:
            id-token: write # Required for OIDC token exchange
        steps:
            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # tag=v6.0.2
              with:
                  submodules: true
                  persist-credentials: false
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # branch=master
              with:
                  toolchain: stable
            - uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # tag=v1.0.3
              id: auth
            - run: cargo publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
